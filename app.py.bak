import os
from flask import Flask, render_template, redirect, url_for, request, jsonify, flash
from flask_login import LoginManager, login_required, current_user
from models import db, User, Account, Holding, Target
from auth import auth_bp, init_oauth

app = Flask(__name__)

# Configuration
app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'dev-secret-key-please-change-in-production')
app.config['SQLALCHEMY_DATABASE_URI'] = os.getenv('DATABASE_URL', 'sqlite:///data/portfolio.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['SESSION_COOKIE_SECURE'] = os.getenv('FLASK_ENV') == 'production'
app.config['SESSION_COOKIE_HTTPONLY'] = True
app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'

# Initialize database
db.init_app(app)

# Initialize Flask-Login
login_manager = LoginManager()
login_manager.init_app(app)
login_manager.login_view = 'auth.login'
login_manager.login_message = 'Please log in to access this page.'
login_manager.login_message_category = 'info'

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

# Initialize OAuth
init_oauth(app)

# Register authentication blueprint
app.register_blueprint(auth_bp, url_prefix='/auth')


# ============================================================================
# ROUTES
# ============================================================================

@app.route('/')
def index():
    '''Landing page'''
    if current_user.is_authenticated:
        return redirect(url_for('dashboard'))
    return render_template('index.html')


@app.route('/dashboard')
@login_required
def dashboard():
    '''Main dashboard showing portfolio overview'''
    accounts = Account.query.filter_by(user_id=current_user.id).all()
    targets = Target.query.filter_by(user_id=current_user.id).all()
    
    # Calculate total portfolio value
    total_value = 0
    for account in accounts:
        for holding in account.holdings:
            total_value += holding.market_value
    
    return render_template('dashboard.html', 
                         user=current_user,
                         accounts=accounts,
                         targets=targets,
                         total_value=total_value)


@app.route('/accounts')
@login_required
def accounts():
    '''View and manage accounts'''
    user_accounts = Account.query.filter_by(user_id=current_user.id).all()
    return render_template('accounts.html', accounts=user_accounts)


@app.route('/accounts/add', methods=['POST'])
@login_required
def add_account():
    '''Add new account'''
    name = request.form.get('name')
    account_type = request.form.get('account_type')
    
    if not name:
        flash('Account name is required', 'error')
        return redirect(url_for('accounts'))
    
    account = Account(
        user_id=current_user.id,
        name=name,
        account_type=account_type
    )
    db.session.add(account)
    db.session.commit()
    
    flash(f'Account "{name}" added successfully', 'success')
    return redirect(url_for('accounts'))


@app.route('/accounts/<int:account_id>/delete', methods=['POST'])
@login_required
def delete_account(account_id):
    '''Delete account'''
    account = Account.query.get_or_404(account_id)
    
    # Verify ownership
    if account.user_id != current_user.id:
        flash('Unauthorized access', 'error')
        return redirect(url_for('accounts'))
    
    db.session.delete(account)
    db.session.commit()
    
    flash(f'Account "{account.name}" deleted successfully', 'success')
    return redirect(url_for('accounts'))


@app.route('/holdings')
@login_required
def holdings():
    '''View all holdings'''
    accounts = Account.query.filter_by(user_id=current_user.id).all()
    return render_template('holdings.html', accounts=accounts)


@app.route('/holdings/add', methods=['POST'])
@login_required
def add_holding():
    '''Add new holding to an account'''
    account_id = request.form.get('account_id')
    ticker = request.form.get('ticker')
    quantity = request.form.get('quantity')
    price = request.form.get('price')
    asset_class = request.form.get('asset_class')
    
    # Validate
    account = Account.query.get_or_404(account_id)
    if account.user_id != current_user.id:
        flash('Unauthorized access', 'error')
        return redirect(url_for('holdings'))
    
    if not all([ticker, quantity, price, asset_class]):
        flash('All fields are required', 'error')
        return redirect(url_for('holdings'))
    
    holding = Holding(
        account_id=account_id,
        ticker=ticker.upper(),
        quantity=float(quantity),
        price=float(price),
        asset_class=asset_class
    )
    db.session.add(holding)
    db.session.commit()
    
    flash(f'Holding {ticker} added successfully', 'success')
    return redirect(url_for('holdings'))


@app.route('/holdings/<int:holding_id>/delete', methods=['POST'])
@login_required
def delete_holding(holding_id):
    '''Delete a holding'''
    holding = Holding.query.get_or_404(holding_id)
    
    # Verify ownership through account
    if holding.account.user_id != current_user.id:
        flash('Unauthorized access', 'error')
        return redirect(url_for('holdings'))
    
    ticker = holding.ticker
    db.session.delete(holding)
    db.session.commit()
    
    flash(f'Holding {ticker} deleted successfully', 'success')
    return redirect(url_for('holdings'))


@app.route('/targets')
@login_required
def targets():
    '''View and edit target allocations'''
    user_targets = Target.query.filter_by(user_id=current_user.id).all()
    return render_template('targets.html', targets=user_targets)


@app.route('/targets/update', methods=['POST'])
@login_required
def update_targets():
    '''Update target allocations'''
    # Delete existing targets
    Target.query.filter_by(user_id=current_user.id).delete()
    
    # Add new targets from form
    target_count = 0
    for key, value in request.form.items():
        if key.startswith('asset_class_'):
            index = key.split('_')[-1]
            asset_class = request.form.get(f'asset_class_{index}')
            percentage = request.form.get(f'percentage_{index}')
            
            if asset_class and percentage:
                target = Target(
                    user_id=current_user.id,
                    asset_class=asset_class,
                    target_percentage=float(percentage)
                )
                db.session.add(target)
                target_count += 1
    
    db.session.commit()
    flash(f'{target_count} target allocation(s) updated successfully', 'success')
    return redirect(url_for('targets'))


@app.route('/rebalance')
@login_required
def rebalance():
    '''Calculate rebalance recommendations'''
    accounts = Account.query.filter_by(user_id=current_user.id).all()
    targets = Target.query.filter_by(user_id=current_user.id).all()
    
    # Calculate current allocation
    asset_totals = {}
    total_portfolio = 0
    
    for account in accounts:
        for holding in account.holdings:
            value = holding.market_value
            total_portfolio += value
            
            if holding.asset_class in asset_totals:
                asset_totals[holding.asset_class] += value
            else:
                asset_totals[holding.asset_class] = value
    
    # Calculate differences
    rebalance_data = []
    for target in targets:
        current_value = asset_totals.get(target.asset_class, 0)
        current_pct = (current_value / total_portfolio * 100) if total_portfolio > 0 else 0
        target_value = total_portfolio * target.target_percentage / 100
        difference = target_value - current_value
        
        rebalance_data.append({
            'asset_class': target.asset_class,
            'current_value': current_value,
            'current_pct': current_pct,
            'target_pct': target.target_percentage,
            'target_value': target_value,
            'difference': difference
        })
    
    return render_template('rebalance.html', 
                         rebalance_data=rebalance_data,
                         total_portfolio=total_portfolio)


# ============================================================================
# API ENDPOINTS
# ============================================================================

@app.route('/api/holdings', methods=['GET'])
@login_required
def api_get_holdings():
    '''API endpoint to get all holdings'''
    accounts = Account.query.filter_by(user_id=current_user.id).all()
    data = []
    
    for account in accounts:
        for holding in account.holdings:
            data.append({
                'account': account.name,
                'ticker': holding.ticker,
                'quantity': holding.quantity,
                'price': holding.price,
                'value': holding.market_value,
                'asset_class': holding.asset_class
            })
    
    return jsonify(data)


@app.route('/api/portfolio/summary', methods=['GET'])
@login_required
def api_portfolio_summary():
    '''API endpoint for portfolio summary'''
    accounts = Account.query.filter_by(user_id=current_user.id).all()
    
    total_value = 0
    asset_allocation = {}
    
    for account in accounts:
        for holding in account.holdings:
            value = holding.market_value
            total_value += value
            
            if holding.asset_class in asset_allocation:
                asset_allocation[holding.asset_class] += value
            else:
                asset_allocation[holding.asset_class] = value
    
    # Convert to percentages
    allocation_pct = {}
    for asset_class, value in asset_allocation.items():
        allocation_pct[asset_class] = (value / total_value * 100) if total_value > 0 else 0
    
    return jsonify({
        'total_value': total_value,
        'num_accounts': len(accounts),
        'asset_allocation': allocation_pct
    })


# ============================================================================
# ERROR HANDLERS
# ============================================================================

@app.errorhandler(404)
def not_found(error):
    return render_template('404.html'), 404


@app.errorhandler(500)
def internal_error(error):
    db.session.rollback()
    return render_template('500.html'), 500


@app.errorhandler(403)
def forbidden(error):
    return render_template('403.html'), 403


# ============================================================================
# INITIALIZATION
# ============================================================================

def init_db():
    '''Initialize database tables'''
    with app.app_context():
        db.create_all()
        print("✓ Database tables created successfully")


# Create tables on import (before gunicorn starts)
with app.app_context():
    db.create_all()
    print("✓ Database initialized")


if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=os.getenv('FLASK_ENV') != 'production')
