{% extends "base.html" %}
{% block title %}Preferences - Portfolio Rebalancer{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Security Preferences</h1>

<!-- Add or Edit Security Preference -->
<div class="card">
    <h2>Manage Preferences by Security</h2>

    <form method="POST" action="{{ url_for('save_preferences') }}">
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
            <!-- Security picker -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="security_id">Security</label>
                <select id="security_id" name="security_id" required>
                    <option value="">Select Security</option>
                    {% for security in securities %}
                        <option value="{{ security.id }}">{{ security.ticker }} - {{ security.asset_class.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Restriction type -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="restriction_type">Restriction Type</label>
                <select id="restriction_type" name="restriction_type" required>
                    {% for r in restriction_types %}
                        <option value="{{ r }}">{{ r.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Optional account if restricted -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="account_id">Apply to Account</label>
                <select id="account_id" name="account_id">
                    <option value="">(All / None)</option>
                    {% for a in accounts %}
                        <option value="{{ a.id }}">{{ a.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Optional notes -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="notes">Notes</label>
                <input type="text" name="notes" placeholder="Optional details (e.g., Tax model preference)">
            </div>

            <button type="submit" class="btn btn-success">Save Preference</button>
        </div>
    </form>
</div>

<!-- Existing preferences -->
<div class="card">
    <h2>Current Preferences</h2>
    {% if preferences %}
    <table>
        <thead>
            <tr>
                <th>Security</th>
                <th>Asset Class</th>
                <th>Restriction Type</th>
                <th>Account</th>
                <th>Notes</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for pref in preferences %}
            <tr>
                <td>{{ pref.security.ticker }}</td>
                <td>{{ pref.security.asset_class.name }}</td>
                <td>{{ pref.restriction_type.replace('_',' ').title() }}</td>
                <td>{{ pref.account.name if pref.account else '-' }}</td>
                <td>{{ pref.notes or '-' }}</td>
                <td>
                    <form method="POST" action="{{ url_for('delete_preference', pref_id=pref.id) }}" onsubmit="return confirm('Delete this preference?');">
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p style="color: #7f8c8d;">No security preferences set yet. Add one above.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('restriction_type').addEventListener('change', function() {
    const acc = document.getElementById('account_id').closest('.form-group');
    acc.style.display = (this.value === 'unrestricted') ? 'none' : 'block';
});
</script>
{% endblock %}


