{% extends "base.html" %}

{% block title %}Securities - Portfolio Rebalancer{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Securities & Preferences</h1>

<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('add_security') }}" class="btn btn-primary">Add New Security</a>
</div>

<div class="card">
    <h2>Securities List</h2>
    <table>
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Name</th>
                <th>Asset Class</th>
                <th>Currency</th>
                <th>Restrictions</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for s in securities %}
            <tr>
                <td><strong>{{ s.ticker }}</strong></td>
                <td>{{ s.name }}</td>
                <td>{{ s.asset_class.name if s.asset_class else '-' }}</td>
                <td>{{ s.currency }}</td>
                <td>
                    {% set pref = preferences.get(s.id) %}
                    {% if pref %}
                        <span class="badge">{{ pref.restriction_type|replace('_', ' ')|title }}</span>
                    {% else %}
                        <span style="color: #95a5a6;">Not set</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-secondary" onclick="openPreferenceModal({{ s.id }}, '{{ s.ticker }}')">
                        Set Preference
                    </button>
                    <a href="{{ url_for('edit_security', security_id=s.id) }}" class="btn btn-warning">Edit</a>
                    <form method="POST" action="{{ url_for('delete_security', security_id=s.id) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger" onclick="return confirm('Delete {{ s.ticker }}?')">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Preference Modal -->
<div id="preferenceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; max-width: 600px; margin: 50px auto; padding: 2rem; border-radius: 8px; max-height: 80vh; overflow-y: auto;">
        <h2 id="modalTitle">Set Security Preference</h2>
        <form method="POST" id="preferenceForm">
            <div class="form-group">
                <label>Restriction Type</label>
                <select name="restriction_type" id="restriction_type" onchange="updatePreferenceFields()" required>
                    <option value="unrestricted">Unrestricted - Can be held in any account</option>
                    <option value="restricted_to_accounts">Restricted - Only specific accounts allowed</option>
                    <option value="prioritized_accounts">Prioritized - Prefer certain accounts over others</option>
                </select>
            </div>

            <!-- Restricted Accounts Section -->
            <div id="restrictedSection" style="display: none;">
                <div class="form-group">
                    <label>Allowed Accounts (select multiple)</label>
                    <select name="allowed_accounts[]" multiple size="5" style="width: 100%;">
                        {% for acc in accounts %}
                            <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.account_type }})</option>
                        {% endfor %}
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple accounts</small>
                </div>
            </div>

            <!-- Prioritized Accounts Section -->
            <div id="prioritizedSection" style="display: none;">
                <div class="form-group">
                    <label>Priority 1 (Most Preferred)</label>
                    <select name="priority_1[]" multiple size="3" style="width: 100%;">
                        {% for acc in accounts %}
                            <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.account_type }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority 2</label>
                    <select name="priority_2[]" multiple size="3" style="width: 100%;">
                        {% for acc in accounts %}
                            <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.account_type }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority 3 (Least Preferred)</label>
                    <select name="priority_3[]" multiple size="3" style="width: 100%;">
                        {% for acc in accounts %}
                            <option value="{{ acc.id }}">{{ acc.name }} ({{ acc.account_type }})</option>
                        {% endfor %}
                    </select>
                </div>
                <small>Hold Ctrl/Cmd to select multiple accounts per priority level</small>
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea name="notes" rows="2" style="width: 100%;"></textarea>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="submit" class="btn btn-primary">Save Preference</button>
                <button type="button" class="btn btn-secondary" onclick="closePreferenceModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentSecurityId = null;

function openPreferenceModal(securityId, ticker) {
    currentSecurityId = securityId;
    document.getElementById('modalTitle').textContent = `Set Preference for ${ticker}`;
    document.getElementById('preferenceForm').action = `/securities/${securityId}/preference`;
    document.getElementById('preferenceModal').style.display = 'block';
    updatePreferenceFields();
}

function closePreferenceModal() {
    document.getElementById('preferenceModal').style.display = 'none';
}

function updatePreferenceFields() {
    const type = document.getElementById('restriction_type').value;
    document.getElementById('restrictedSection').style.display = type === 'restricted_to_accounts' ? 'block' : 'none';
    document.getElementById('prioritizedSection').style.display = type === 'prioritized_accounts' ? 'block' : 'none';
}
</script>

{% endblock %}

