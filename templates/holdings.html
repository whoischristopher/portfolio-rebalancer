{% extends "base.html" %}
{% block title %}Holdings - Portfolio Rebalancer{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Holdings</h1>

<!-- Add new holding form as before -->
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>Add New Holding</h2>
    <form method="POST" action="{{ url_for('update_prices') }}" style="display: inline;">
      <button type="submit" class="btn btn-primary">ðŸ”„ Update Prices from Market</button>
    </form>
  </div>

  <form method="POST" action="{{ url_for('add_holding') }}">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem;">
      <!-- Stay the same as before -->
      <div class="form-group">
        <label for="account_id">Account</label>
        <select id="account_id" name="account_id" required>
          <option value="">Select Account</option>
          {% for account in accounts %}
            <option value="{{ account.id }}">{{ account.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="security_id">Security</label>
        <select name="security_id" id="security_id" required>
          <option value="">Select Security</option>
          {% for sec in securities %}
            <option value="{{ sec.id }}">{{ sec.ticker }} - {{ sec.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label for="quantity">Quantity</label>
        <input type="number" step="0.001" id="quantity" name="quantity" required placeholder="100">
      </div>
      <div class="form-group">
        <label for="price">Price (optional)</label>
        <input type="number" step="0.01" id="price" name="price" placeholder="Auto-fetch">
      </div>
    </div>
    <button type="submit" class="btn btn-success">Add Holding</button>
  </form>
</div>

<!-- Holdings per Account -->
{% for account in accounts %}
<div class="card">
  <h2>{{ account.name }} 
    <span style="color: #7f8c8d; font-size: 0.9rem;">
      ({{ account.account_type or 'N/A' }}, {{ account.currency }}
      {% if account.is_registered %}, Registered{% endif %})
    </span>
  </h2>

  {% if account.holdings %}
  <table>
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Name</th>
        <th>Asset Class</th>
        <th>Type</th>
        <th class="text-right">Quantity</th>
        <th class="text-right">Price</th>
        <th class="text-right">Market Value</th>
        <th class="text-right">Value ({{ base_currency }})</th>
        <th>Notes</th>
        <th>Last Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for holding in account.holdings %}
      <tr>
        <td><strong>{{ holding.security.ticker if holding.security else holding.ticker }}</strong></td>
        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;">
          {{ holding.security.name if holding.security else holding.name or '-' }}
        </td>
        <td>{{ holding.security.asset_class.name if holding.security and holding.security.asset_class else holding.asset_class or '-' }}</td>

        <td>
          {% if holding.is_public %}
            <span style="color: #3498db;">Public</span>
          {% else %}
            <span style="color: #e67e22;">Private</span>
          {% endif %}
        </td>

        <td class="text-right">{{ "%.3f"|format(holding.quantity) }}</td>
        <td class="text-right">{{ holding.currency }} ${{ "%.2f"|format(holding.price) }}</td>
        <td class="text-right"><strong>{{ holding.currency }} ${{ "%.2f"|format(holding.market_value) }}</strong></td>
        <td class="text-right">
          {% if holding.currency != base_currency %}
            {{ base_currency }} ${{ "%.2f"|format(holding.market_value_in_base_currency(exchange_rates)) }}
          {% else %}
            -
          {% endif %}
        </td>

        <td>
          {% if holding.security and holding.security.preferences %}
            {{ holding.security.preferences[0].notes or '-' }}
          {% else %}
            -
          {% endif %}
        </td>

        <td style="font-size: 0.85rem; color: #7f8c8d;">
          {% if holding.last_price_update %}
            {{ holding.last_price_update.strftime('%Y-%m-%d') }}
          {% else %}
            Never
          {% endif %}
        </td>

        <td>
          <form method="GET"
                action="{{ url_for('edit_holding', holding_id=holding.id) }}"
                style="display: inline;">
            <button type="submit" class="btn btn-warning">Edit</button>
          </form>
          <form method="POST"
                action="{{ url_for('delete_holding', holding_id=holding.id) }}"
                style="display: inline;"
                onsubmit="return confirm('Are you sure you want to delete this holding?');">
              <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}

      <tr style="background: #f8f9fa; font-weight: bold;">
        <td colspan="7" class="text-right">Account Total:</td>
        <td class="text-right">{{ account.currency }} ${{ "%.2f"|format(account.holdings|sum(attribute='market_value')) }}</td>
        <td colspan="4"></td>
      </tr>
    </tbody>
  </table>
  {% else %}
    <p style="color: #7f8c8d; margin-top: 1rem;">No holdings in this account yet.</p>
  {% endif %}
</div>
{% endfor %}

{% if not accounts %}
<div class="card">
  <p style="color: #7f8c8d;">No accounts yet. <a href="{{ url_for('accounts') }}">Create an account first</a>.</p>
</div>
{% endif %}
{% endblock %}

