<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Rebalancer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2.5em;
            font-weight: 600;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-top: 10px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close {
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-usd {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-cad {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-private {
            background: #fff3e0;
            color: #e65100;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üíº Portfolio Rebalancer</h1>
            <p class="subtitle">Multi-Account Portfolio Management with Database Storage</p>
        </div>
    </header>

    <div class="container">
        <div id="alerts"></div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="switchTab('accounts')">üè¶ Accounts</button>
            <button class="tab" onclick="switchTab('securities')">üìà Securities</button>
            <button class="tab" onclick="switchTab('holdings')">üí∞ Holdings</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            <button class="tab" onclick="switchTab('asset-classes')">üéØ Asset Classes</button>
            <button class="tab" onclick="switchTab('rebalance')">‚öñÔ∏è Rebalance</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Portfolio Overview</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Accounts</div>
                    <div class="stat-value" id="total-accounts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Securities</div>
                    <div class="stat-value" id="total-securities">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Holdings</div>
                    <div class="stat-value" id="total-holdings">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Database Status</div>
                    <div class="stat-value" id="db-status">‚úì Active</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-success" onclick="exportData()">üì• Export Data</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
                <button class="btn" onclick="loadData()">üîÑ Refresh Data</button>
            </div>
        </div>

        <!-- Accounts Tab -->
        <div id="accounts" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Investment Accounts</h2>
                <button class="btn" onclick="openAccountModal()">+ Add Account</button>
            </div>
            <div id="accounts-list"></div>
        </div>

        <!-- Securities Tab -->
        <div id="securities" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Securities</h2>
                <button class="btn" onclick="openSecurityModal()">+ Add Security</button>
            </div>
            <div id="securities-list"></div>
        </div>

        <!-- Holdings Tab -->
        <div id="holdings" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Holdings</h2>
                <button class="btn" onclick="openHoldingModal()">+ Add Holding</button>
            </div>
            <div id="holdings-list"></div>
        </div>

        <!-- Asset Classes Tab -->
        <div id="asset-classes" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Asset Allocation</h2>
                <button class="btn" onclick="openAssetClassModal()">+ Add Asset Class</button>
            </div>
            <p style="color: #6c757d; margin-bottom: 20px;">Define your target asset allocation. Total should equal 100%.</p>
            <div id="asset-classes-list"></div>
            <div id="allocation-summary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;"></div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <h2>Settings</h2>
            <div class="form-group">
                <label>Base Currency</label>
                <select id="base-currency" onchange="saveSetting('base_currency', this.value)">
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="USD">USD - US Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                </select>
            </div>
            <div class="form-group">
                <label>USD/CAD Exchange Rate</label>
                <input type="number" id="exchange-rate" step="0.0001" placeholder="1.4048" onchange="saveSetting('usdcad_rate', this.value)">
                <button class="btn" onclick="fetchExchangeRate()" style="margin-top: 10px;">Fetch Current Rate</button>
            </div>
        </div>

        <!-- Rebalancing Tab -->
        <div id="rebalance" class="tab-content">
            <h2>Portfolio Rebalancing</h2>
            <p style="color: #6c757d; margin-bottom: 20px;">
                Calculate trades needed to bring your portfolio back to target allocation.
            </p>
            
            <div class="action-buttons" style="margin-bottom: 30px;">
                <button class="btn btn-success" onclick="calculateRebalancing()">üîÑ Calculate Rebalancing</button>
                <button class="btn" onclick="refreshPricesForRebalance()">üí∞ Refresh Prices</button>
            </div>

            <div id="rebalancing-results"></div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="accountModalTitle">Add Account</h2>
                <span class="close" onclick="closeModal('accountModal')">&times;</span>
            </div>
            <form id="accountForm" onsubmit="saveAccount(event)">
                <input type="hidden" id="account-id">
                <div class="form-group">
                    <label>Account Name *</label>
                    <input type="text" id="account-name" required placeholder="e.g., TFSA, RRSP">
                </div>
                <div class="form-group">
                    <label>Account Label</label>
                    <input type="text" id="account-label" placeholder="e.g., Tax-Free Savings Account">
                </div>
                <div class="form-group">
                    <label>Cash Balance</label>
                    <input type="number" id="account-cash" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>Cash Currency</label>
                    <select id="account-currency">
                        <option value="CAD">CAD</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('accountModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Modal -->
    <div id="securityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="securityModalTitle">Add Security</h2>
                <span class="close" onclick="closeModal('securityModal')">&times;</span>
            </div>
            <form id="securityForm" onsubmit="saveSecurity(event)">
                <input type="hidden" id="security-id">
                <div class="form-group">
                    <label>Symbol * (e.g., VTI or XIU.TO for Canadian)</label>
                    <input type="text" id="security-symbol" required placeholder="VTI">
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="security-name" placeholder="Vanguard Total Stock Market ETF">
                </div>
                <div class="form-group">
                    <label>Price Currency</label>
                    <select id="security-currency">
                        <option value="USD">USD</option>
                        <option value="CAD">CAD</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Asset Class</label>
                    <select id="security-asset-class">
                        <option value="">-- Select Asset Class --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="security-private">
                        Private Security (manual pricing)
                    </label>
                </div>
                <div class="form-group" id="manual-price-group" style="display:none;">
                    <label>Manual Price</label>
                    <input type="number" id="security-manual-price" step="0.01">
                </div>
                <div class="form-group">
                    <label>Account Preference Mode</label>
                    <select id="security-preference-mode" onchange="togglePreferenceOptions()">
                        <option value="none">No Preference - Any Account</option>
                        <option value="preferred">Preferred Order - With Fallback</option>
                        <option value="restricted">Restricted - Specific Accounts Only</option>
                    </select>
                </div>
                <div id="preference-options" style="display:none;">
                    <div class="form-group">
                        <label>Allowed Accounts</label>
                        <div id="allowed-accounts-list" class="checkbox-group"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('securityModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Asset Class Modal -->
    <div id="assetClassModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="assetClassModalTitle">Add Asset Class</h2>
                <span class="close" onclick="closeModal('assetClassModal')">&times;</span>
            </div>
            <form id="assetClassForm" onsubmit="saveAssetClass(event)">
                <input type="hidden" id="assetclass-id">
                <div class="form-group">
                    <label>Asset Class Name *</label>
                    <input type="text" id="assetclass-name" required placeholder="e.g., US Equity, Bonds, REITs">
                </div>
                <div class="form-group">
                    <label>Target Allocation (%) *</label>
                    <input type="number" id="assetclass-target" step="0.01" min="0" max="100" required placeholder="e.g., 60">
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assetClassModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Holding Modal -->
    <div id="holdingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add/Edit Holding</h2>
                <span class="close" onclick="closeModal('holdingModal')">&times;</span>
            </div>
            <form id="holdingForm" onsubmit="saveHolding(event)">
                <div class="form-group">
                    <label>Account *</label>
                    <select id="holding-account" required></select>
                </div>
                <div class="form-group">
                    <label>Security *</label>
                    <select id="holding-security" required></select>
                </div>
                <div class="form-group">
                    <label>Shares *</label>
                    <input type="number" id="holding-shares" step="0.0001" required>
                </div>
                <div class="action-buttons">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('holdingModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let accounts = [];
        let securities = [];
        let holdings = [];
        let settings = {};
        let assetClasses = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('security-private').addEventListener('change', function() {
                document.getElementById('manual-price-group').style.display = this.checked ? 'block' : 'none';
            });
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method,
                    headers: {'Content-Type': 'application/json'}
                };
                if (data) options.body = JSON.stringify(data);
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadData() {
            try {
                showAlert('Loading data...', 'info');
                accounts = await apiCall('/accounts');
                securities = await apiCall('/securities');
                holdings = await apiCall('/holdings');
                settings = await apiCall('/settings');
                assetClasses = await apiCall('/asset_classes');
                
                renderDashboard();
                renderAccounts();
                renderSecurities();
                renderHoldings();
                loadSettings();
                renderAssetClasses();
                
                showAlert('Data loaded successfully', 'success');
                setTimeout(() => document.getElementById('alerts').innerHTML = '', 3000);
            } catch (error) {
                showAlert('Failed to load data from database', 'error');
            }
        }

        function renderDashboard() {
            document.getElementById('total-accounts').textContent = accounts.length;
            document.getElementById('total-securities').textContent = securities.length;
            document.getElementById('total-holdings').textContent = holdings.length;
        }

        function renderAccounts() {
            const list = document.getElementById('accounts-list');
            if (accounts.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè¶</div><p>No accounts yet. Click "Add Account" to get started.</p></div>';
                return;
            }

            let html = '<table><thead><tr><th>Name</th><th>Label</th><th>Cash</th><th>Currency</th><th>Actions</th></tr></thead><tbody>';
            accounts.forEach(acc => {
                html += `<tr>
                    <td><strong>${acc.name}</strong></td>
                    <td>${acc.label || '-'}</td>
                    <td>$${parseFloat(acc.cash || 0).toFixed(2)}</td>
                    <td><span class="badge badge-${acc.cash_currency.toLowerCase()}">${acc.cash_currency}</span></td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick='editAccount(${JSON.stringify(acc)})'>Edit</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteAccount('${acc.id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            list.innerHTML = html;
        }

        function openAccountModal(account = null) {
            document.getElementById('accountModalTitle').textContent = account ? 'Edit Account' : 'Add Account';
            document.getElementById('account-id').value = account?.id || '';
            document.getElementById('account-name').value = account?.name || '';
            document.getElementById('account-label').value = account?.label || '';
            document.getElementById('account-cash').value = account?.cash || 0;
            document.getElementById('account-currency').value = account?.cash_currency || 'CAD';
            document.getElementById('accountModal').classList.add('active');
        }

        function editAccount(account) {
            openAccountModal(account);
        }

        async function saveAccount(event) {
            event.preventDefault();
            const id = document.getElementById('account-id').value || generateId();
            const data = {
                id,
                name: document.getElementById('account-name').value,
                label: document.getElementById('account-label').value,
                cash: parseFloat(document.getElementById('account-cash').value),
                cash_currency: document.getElementById('account-currency').value
            };

            try {
                if (document.getElementById('account-id').value) {
                    await apiCall(`/accounts/${id}`, 'PUT', data);
                } else {
                    await apiCall('/accounts', 'POST', data);
                }
                closeModal('accountModal');
                loadData();
            } catch (error) {
                showAlert('Failed to save account', 'error');
            }
        }

        async function deleteAccount(id) {
            if (!confirm('Delete this account? All holdings will be removed.')) return;
            try {
                await apiCall(`/accounts/${id}`, 'DELETE');
                loadData();
            } catch (error) {
                showAlert('Failed to delete account', 'error');
            }
        }

        function renderSecurities() {
            const list = document.getElementById('securities-list');
            if (securities.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìà</div><p>No securities yet. Click "Add Security" to get started.</p></div>';
                return;
            }

            let html = '<table><thead><tr><th>Symbol</th><th>Name</th><th>Currency</th><th>Type</th><th>Preference</th><th>Actions</th></tr></thead><tbody>';
            securities.forEach(sec => {
                const secJson = JSON.stringify(sec).replace(/"/g, '&quot;');
                html += `<tr>
                    <td><strong>${sec.symbol}</strong></td>
                    <td>${sec.name || '-'}</td>
                    <td><span class="badge badge-${sec.price_currency.toLowerCase()}">${sec.price_currency}</span></td>
                    <td>${sec.is_private ? '<span class="badge badge-private">Private</span>' : 'Public'}</td>
                    <td>${sec.preference_mode || 'none'}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick='editSecurity(${secJson})'>Edit</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteSecurity('${sec.id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            list.innerHTML = html;
        }


        function openSecurityModal(security = null) {
            document.getElementById('securityModalTitle').textContent = security ? 'Edit Security' : 'Add Security';
            document.getElementById('security-id').value = security?.id || '';
            document.getElementById('security-symbol').value = security?.symbol || '';
            document.getElementById('security-name').value = security?.name || '';
            document.getElementById('security-currency').value = security?.price_currency || 'USD';
            document.getElementById('security-private').checked = security?.is_private || false;
            document.getElementById('security-manual-price').value = security?.manual_price || '';
            document.getElementById('security-preference-mode').value = security?.preference_mode || 'none';
            
            // Populate asset class dropdown
            const assetClassSelect = document.getElementById('security-asset-class');
            assetClassSelect.innerHTML = '<option value="">-- Select Asset Class --</option>';
            assetClasses.forEach(ac => {
                const selected = security?.asset_class === ac.id ? 'selected' : '';
                assetClassSelect.innerHTML += `<option value="${ac.id}" ${selected}>${ac.name}</option>`;
            });
            
            document.getElementById('manual-price-group').style.display = security?.is_private ? 'block' : 'none';
            togglePreferenceOptions();
            
            if (security && (security.preference_mode === 'preferred' || security.preference_mode === 'restricted')) {
                populateAllowedAccounts(security.allowed_accounts || []);
            }
            
            document.getElementById('securityModal').classList.add('active');
        }

        function editSecurity(security) {
            openSecurityModal(security);
        }

        function togglePreferenceOptions() {
            const mode = document.getElementById('security-preference-mode').value;
            const options = document.getElementById('preference-options');
            options.style.display = (mode === 'preferred' || mode === 'restricted') ? 'block' : 'none';
            if (options.style.display === 'block') {
                populateAllowedAccounts([]);
            }
        }

        function populateAllowedAccounts(selectedAccounts = []) {
            const container = document.getElementById('allowed-accounts-list');
            container.innerHTML = '';
            accounts.forEach(acc => {
                const checked = selectedAccounts.includes(acc.id) ? 'checked' : '';
                container.innerHTML += `
                    <div class="checkbox-item">
                        <input type="checkbox" id="acc-${acc.id}" value="${acc.id}" ${checked}>
                        <label for="acc-${acc.id}">${acc.name}</label>
                    </div>
                `;
            });
        }

        async function saveSecurity(event) {
            event.preventDefault();
            const id = document.getElementById('security-id').value || generateId();
            
            const allowedAccounts = [];
            if (document.getElementById('preference-options').style.display !== 'none') {
                document.querySelectorAll('#allowed-accounts-list input:checked').forEach(cb => {
                    allowedAccounts.push(cb.value);
                });
            }

            const data = {
                id,
                symbol: document.getElementById('security-symbol').value,
                name: document.getElementById('security-name').value,
                price_currency: document.getElementById('security-currency').value,
                asset_class: document.getElementById('security-asset-class').value,
                is_private: document.getElementById('security-private').checked,
                manual_price: document.getElementById('security-manual-price').value || null,
                preference_mode: document.getElementById('security-preference-mode').value,
                allowed_accounts: allowedAccounts,
                account_priority: {}
            };

            try {
                if (document.getElementById('security-id').value) {
                    await apiCall(`/securities/${id}`, 'PUT', data);
                } else {
                    await apiCall('/securities', 'POST', data);
                }
                closeModal('securityModal');
                loadData();
            } catch (error) {
                showAlert('Failed to save security', 'error');
            }
        }

        async function deleteSecurity(id) {
            if (!confirm('Delete this security?')) return;
            try {
                await apiCall(`/securities/${id}`, 'DELETE');
                loadData();
            } catch (error) {
                showAlert('Failed to delete security', 'error');
            }
        }

        function renderHoldings() {
            const list = document.getElementById('holdings-list');
            if (holdings.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><p>No holdings yet. Click "Add Holding" to get started.</p></div>';
                return;
            }

            let html = '<table><thead><tr><th>Account</th><th>Symbol</th><th>Shares</th><th>Actions</th></tr></thead><tbody>';
            holdings.forEach(holding => {
                const account = accounts.find(a => a.id === holding.account_id);
                html += `<tr>
                    <td>${account?.name || holding.account_id}</td>
                    <td><strong>${holding.symbol}</strong></td>
                    <td>${holding.shares}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteHolding(${holding.id})">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            list.innerHTML = html;
        }

        function openHoldingModal() {
            const accountSelect = document.getElementById('holding-account');
            const securitySelect = document.getElementById('holding-security');
            
            accountSelect.innerHTML = accounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
            securitySelect.innerHTML = securities.map(s => `<option value="${s.symbol}">${s.symbol} - ${s.name}</option>`).join('');
            
            document.getElementById('holding-shares').value = '';
            document.getElementById('holdingModal').classList.add('active');
        }

        async function saveHolding(event) {
            event.preventDefault();
            const data = {
                account_id: document.getElementById('holding-account').value,
                symbol: document.getElementById('holding-security').value,
                shares: parseFloat(document.getElementById('holding-shares').value)
            };

            try {
                await apiCall('/holdings', 'POST', data);
                closeModal('holdingModal');
                loadData();
            } catch (error) {
                showAlert('Failed to save holding', 'error');
            }
        }

        async function deleteHolding(id) {
            if (!confirm('Delete this holding?')) return;
            try {
                await apiCall(`/holdings/${id}`, 'DELETE');
                loadData();
            } catch (error) {
                showAlert('Failed to delete holding', 'error');
            }
        }

        function loadSettings() {
            document.getElementById('base-currency').value = settings.base_currency || 'CAD';
            document.getElementById('exchange-rate').value = settings.usdcad_rate || '1.4048';
        }

        async function saveSetting(key, value) {
            try {
                await apiCall(`/settings/${key}`, 'PUT', { value });
                showAlert('Setting saved', 'success');
                setTimeout(() => document.getElementById('alerts').innerHTML = '', 2000);
            } catch (error) {
                showAlert('Failed to save setting', 'error');
            }
        }

        async function fetchExchangeRate() {
            try {
                const data = await apiCall('/exchange_rate/USD/CAD');
                document.getElementById('exchange-rate').value = data.rate;
                await saveSetting('usdcad_rate', data.rate);
                showAlert(`Exchange rate updated: ${data.rate}`, 'success');
            } catch (error) {
                showAlert('Failed to fetch exchange rate (may be rate limited)', 'error');
            }
        }

        async function exportData() {
            try {
                const data = await apiCall('/export');
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                showAlert('Data exported successfully', 'success');
            } catch (error) {
                showAlert('Failed to export data', 'error');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                await apiCall('/import', 'POST', data);
                showAlert('Data imported successfully', 'success');
                loadData();
            } catch (error) {
                showAlert('Failed to import data', 'error');
            }
        }

        function showAlert(message, type = 'info') {
            const alerts = document.getElementById('alerts');
            alerts.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        // ==================== ASSET CLASSES ====================

        function renderAssetClasses() {
            const list = document.getElementById('asset-classes-list');
            const summary = document.getElementById('allocation-summary');
            
            if (assetClasses.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>No asset classes yet. Click "Add Asset Class" to define your target allocation.</p></div>';
                summary.innerHTML = '';
                return;
            }

            let html = '<table><thead><tr><th>Asset Class</th><th>Target Allocation</th><th>Actions</th></tr></thead><tbody>';
            let total = 0;
            
            assetClasses.forEach(ac => {
                total += parseFloat(ac.target_allocation || 0);
                html += `<tr>
                    <td><strong>${ac.name}</strong></td>
                    <td>${ac.target_allocation}%</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick='editAssetClass(${JSON.stringify(ac)})'>Edit</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="deleteAssetClass('${ac.id}')">Delete</button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            list.innerHTML = html;

            // Show summary
            const color = Math.abs(total - 100) < 0.01 ? '#28a745' : '#dc3545';
            summary.innerHTML = `
                <strong>Total Allocation:</strong> 
                <span style="color: ${color}; font-size: 20px; font-weight: 600;">${total.toFixed(2)}%</span>
                ${Math.abs(total - 100) < 0.01 ? ' ‚úì Perfect!' : ' ‚ö† Should equal 100%'}
            `;
        }

        function openAssetClassModal(assetClass = null) {
            document.getElementById('assetClassModalTitle').textContent = assetClass ? 'Edit Asset Class' : 'Add Asset Class';
            document.getElementById('assetclass-id').value = assetClass?.id || '';
            document.getElementById('assetclass-name').value = assetClass?.name || '';
            document.getElementById('assetclass-target').value = assetClass?.target_allocation || '';
            document.getElementById('assetClassModal').classList.add('active');
        }

        function editAssetClass(assetClass) {
            openAssetClassModal(assetClass);
        }

        async function saveAssetClass(event) {
            event.preventDefault();
            const id = document.getElementById('assetclass-id').value || generateId();
            const data = {
                id,
                name: document.getElementById('assetclass-name').value,
                target_allocation: parseFloat(document.getElementById('assetclass-target').value)
            };

            try {
                if (document.getElementById('assetclass-id').value) {
                    // Update existing
                    await apiCall(`/asset_classes/${id}`, 'PUT', data);
                } else {
                    // Create new
                    await apiCall('/asset_classes', 'POST', data);
                }
                closeModal('assetClassModal');
                loadData();
                showAlert('Asset class saved', 'success');
            } catch (error) {
                showAlert('Failed to save asset class', 'error');
            }
        }

        async function deleteAssetClass(id) {
            if (!confirm('Delete this asset class?')) return;
            try {
                await apiCall(`/asset_classes/${id}`, 'DELETE');
                loadData();
                showAlert('Asset class deleted', 'success');
            } catch (error) {
                showAlert('Failed to delete asset class', 'error');
            }
        }

        // ==================== REBALANCING ====================

        async function refreshPricesForRebalance() {
            showAlert('Fetching current prices...', 'info');
            let updated = 0;
            let errors = 0;

            for (const sec of securities) {
                if (sec.is_private) continue; // Skip private securities
                
                try {
                    const priceData = await apiCall(`/price/${sec.symbol}`);
                    // Update security price in database
                    await apiCall(`/securities/${sec.id}`, 'PUT', {
                        ...sec,
                        price: priceData.price
                    });
                    updated++;
                    await new Promise(resolve => setTimeout(resolve, 3500)); // Rate limiting
                } catch (error) {
                    console.error(`Failed to fetch price for ${sec.symbol}:`, error);
                    errors++;
                }
            }

            showAlert(`Prices updated: ${updated} successful, ${errors} failed`, errors > 0 ? 'error' : 'success');
            loadData();
        }

        // ==================== REBALANCING ====================

        function calculateRebalancing() {
            try {
                showAlert('Calculating rebalancing...', 'info');
                
                // Validate data
                if (assetClasses.length === 0) {
                    showAlert('Please add asset classes first', 'error');
                    document.getElementById('rebalancing-results').innerHTML = 
                        '<div class="alert alert-error">No asset classes defined. Go to Asset Classes tab to add them.</div>';
                    return;
                }

                if (holdings.length === 0) {
                    showAlert('No holdings found', 'error');
                    document.getElementById('rebalancing-results').innerHTML = 
                        '<div class="alert alert-error">No holdings found. Add holdings first.</div>';
                    return;
                }

                // Get exchange rate
                const exchangeRate = parseFloat(settings.usdcad_rate || 1.4048);
                
                // Calculate totals
                const assetClassValues = {};
                let totalValue = 0;

                // Initialize
                assetClasses.forEach(ac => {
                    assetClassValues[ac.id] = 0;
                });

                // Calculate current holdings value
                holdings.forEach(holding => {
                    const security = securities.find(s => s.symbol === holding.symbol);
                    if (!security || !security.asset_class) return;

                    // Get price
                    let price = 0;
                    if (security.is_private && security.manual_price) {
                        price = parseFloat(security.manual_price);
                    } else if (security.price) {
                        price = parseFloat(security.price);
                    }

                    if (price <= 0) return;

                    // Calculate value
                    let value = price * parseFloat(holding.shares);

                    // Convert USD to CAD
                    if (security.price_currency === 'USD') {
                        value *= exchangeRate;
                    }

                    assetClassValues[security.asset_class] = 
                        (assetClassValues[security.asset_class] || 0) + value;
                    totalValue += value;
                });

                // Add cash
                accounts.forEach(acc => {
                    let cash = parseFloat(acc.cash || 0);
                    if (acc.cash_currency === 'USD') {
                        cash *= exchangeRate;
                    }
                    totalValue += cash;
                });

                // Build results
                const results = [];
                assetClasses.forEach(ac => {
                    const currentValue = assetClassValues[ac.id] || 0;
                    const currentPercent = totalValue > 0 ? (currentValue / totalValue * 100) : 0;
                    const targetPercent = parseFloat(ac.target_allocation || 0);
                    const targetValue = totalValue * targetPercent / 100;
                    const diff = targetValue - currentValue;

                    results.push({
                        id: ac.id,  // ADD THIS LINE
                        name: ac.name,
                        currentValue: currentValue,
                        currentPercent: currentPercent,
                        targetPercent: targetPercent,
                        difference: diff
                    });
                });

                // Display
                displayRebalancingResults(results, totalValue, exchangeRate);
                
            } catch (error) {
                console.error('Rebalancing error:', error);
                showAlert('Error calculating rebalancing: ' + error.message, 'error');
            }
        }

        function displayRebalancingResults(results, totalValue, exchangeRate) {
            const container = document.getElementById('rebalancing-results');

            // Helper function to format currency
            function formatCAD(amount) {
                return 'C$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Portfolio Summary</h3>
                    <p><strong>Total Portfolio Value:</strong> ${formatCAD(totalValue)}</p>
                    <p><strong>Exchange Rate:</strong> 1 USD = ${exchangeRate.toFixed(4)} CAD</p>
                </div>

                <h3>Current vs Target Allocation</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Asset Class</th>
                            <th>Current Value</th>
                            <th>Current %</th>
                            <th>Target %</th>
                            <th>Difference</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(r => {
                const color = Math.abs(r.currentPercent - r.targetPercent) < 1 ? '#28a745' : 
                             Math.abs(r.currentPercent - r.targetPercent) < 5 ? '#ffc107' : '#dc3545';
                const arrow = r.difference > 0 ? '‚Üë' : r.difference < 0 ? '‚Üì' : '‚Üí';
                
                html += `
                    <tr>
                        <td><strong>${r.name}</strong></td>
                        <td>${formatCAD(r.currentValue)}</td>
                        <td style="color: ${color}; font-weight: 600;">${r.currentPercent.toFixed(2)}%</td>
                        <td>${r.targetPercent.toFixed(2)}%</td>
                        <td style="color: ${color};">
                            ${arrow} ${Math.abs(r.currentPercent - r.targetPercent).toFixed(2)}%
                            <br><small>${formatCAD(Math.abs(r.difference))}</small>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';

            // Generate specific trade recommendations with cash flow sequencing
            html += `
                <div style="margin-top: 30px;">
                    <h3>üìã Recommended Trades</h3>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                        <strong>‚ö†Ô∏è Important:</strong> These trades are sequenced to manage cash flow. 
                        SELL orders are listed first to generate cash for BUY orders. 
                        Consider transaction costs, tax implications, and market conditions before executing.
                    </div>
            `;

            // Separate trades into SELL and BUY, then sequence them
            const sellTrades = [];
            const buyTrades = [];
            let totalCashFromSells = 0;
            let totalCashNeededForBuys = 0;

            // Calculate current available cash
            let availableCash = 0;
            accounts.forEach(acc => {
                let cash = parseFloat(acc.cash || 0);
                if (acc.cash_currency === 'USD') {
                    cash *= exchangeRate;
                }
                availableCash += cash;
            });

            // Process each asset class
            results.forEach(result => {
                if (Math.abs(result.difference) < 100) return; // Skip small differences

                const action = result.difference > 0 ? 'BUY' : 'SELL';
                const amount = Math.abs(result.difference);

                // Find securities in this asset class
                const assetClassSecurities = securities.filter(s => s.asset_class === result.id);
                
                if (assetClassSecurities.length === 0) {
                    const trade = {
                        type: action,
                        assetClass: result.name,
                        amount: amount,
                        error: 'No securities found in this asset class'
                    };
                    if (action === 'SELL') {
                        sellTrades.push(trade);
                    } else {
                        buyTrades.push(trade);
                    }
                    return;
                }

                // Select the BEST security for this asset class using smart prioritization
                let selectedSecurity = null;
                let selectionReason = '';
                
                // Strategy 1: For SELL orders, prefer securities we hold the most of
                if (action === 'SELL') {
                    let maxHolding = 0;
                    for (const security of assetClassSecurities) {
                        const totalShares = holdings
                            .filter(h => h.symbol === security.symbol)
                            .reduce((sum, h) => sum + parseFloat(h.shares || 0), 0);
                        
                        if (totalShares > maxHolding) {
                            maxHolding = totalShares;
                            selectedSecurity = security;
                            selectionReason = `Largest holding (${totalShares.toFixed(2)} shares)`;
                        }
                    }
                }
                
                // Strategy 2: For BUY orders, prefer securities with account restrictions (tax efficiency)
                if (action === 'BUY' && !selectedSecurity) {
                    const restrictedSec = assetClassSecurities.find(s => 
                        s.preference_mode === 'restricted' && s.allowed_accounts?.length > 0
                    );
                    if (restrictedSec) {
                        selectedSecurity = restrictedSec;
                        selectionReason = 'Tax-optimized (restricted accounts)';
                    }
                }
                
                // Strategy 3: Prefer securities we already hold (avoid creating new positions)
                if (!selectedSecurity) {
                    for (const security of assetClassSecurities) {
                        const existingHolding = holdings.find(h => h.symbol === security.symbol);
                        if (existingHolding) {
                            selectedSecurity = security;
                            selectionReason = 'Existing holding';
                            break;
                        }
                    }
                }
                
                // Strategy 4: Prefer securities with preferred accounts
                if (!selectedSecurity) {
                    const preferredSec = assetClassSecurities.find(s => 
                        s.preference_mode === 'preferred' && s.allowed_accounts?.length > 0
                    );
                    if (preferredSec) {
                        selectedSecurity = preferredSec;
                        selectionReason = 'Preferred accounts configured';
                    }
                }
                
                // Strategy 5: Default to first security
                if (!selectedSecurity && assetClassSecurities.length > 0) {
                    selectedSecurity = assetClassSecurities[0];
                    selectionReason = 'First security in asset class';
                }
                
                if (!selectedSecurity) return;
                
                // Process only the selected security
                const security = selectedSecurity;

                // Get price
                let price = security.is_private && security.manual_price ? 
                    parseFloat(security.manual_price) : 
                    parseFloat(security.price || 0);
                
                if (price <= 0) {
                    const trade = {
                        type: action,
                        security: security,
                        assetClass: result.name,
                        amount: amount,
                        error: 'No price available',
                        selectionReason: selectionReason
                    };
                    if (action === 'SELL') {
                        sellTrades.push(trade);
                    } else {
                        buyTrades.push(trade);
                    }
                    return;
                }

                // Determine recommended account(s)
                let recommendedAccounts = [];
                if (security.preference_mode === 'restricted' && security.allowed_accounts?.length > 0) {
                    recommendedAccounts = security.allowed_accounts.map(accId => 
                        accounts.find(a => a.id === accId)
                    ).filter(a => a);
                } else if (security.preference_mode === 'preferred' && security.allowed_accounts?.length > 0) {
                    recommendedAccounts = security.allowed_accounts.map(accId => 
                        accounts.find(a => a.id === accId)
                    ).filter(a => a);
                    if (recommendedAccounts.length === 0) {
                        recommendedAccounts = accounts;
                    }
                } else {
                    recommendedAccounts = accounts;
                }

                // Calculate shares and costs
                let amountInSecurityCurrency = amount;
                if (security.price_currency === 'USD') {
                    amountInSecurityCurrency = amount / exchangeRate;
                }

                const shares = Math.floor(amountInSecurityCurrency / price);
                const totalCost = shares * price;
                const totalCostCAD = security.price_currency === 'USD' ? totalCost * exchangeRate : totalCost;

                // Track cash flow
                if (action === 'SELL') {
                    totalCashFromSells += totalCostCAD;
                } else {
                    totalCashNeededForBuys += totalCostCAD;
                }

                // Build trade object
                const trade = {
                    type: action,
                    security: security,
                    assetClass: result.name,
                    shares: shares,
                    price: price,
                    totalCost: totalCost,
                    totalCostCAD: totalCostCAD,
                    recommendedAccounts: recommendedAccounts,
                    accountReason: security.preference_mode,
                    selectionReason: selectionReason || ''
                };


                if (action === 'SELL') {
                    sellTrades.push(trade);
                } else {
                    buyTrades.push(trade);
                }

            });

            // Helper function to format currency
            function formatCAD(amount) {
                return 'C$' + amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            // Display cash flow summary
            const cashAfterSells = availableCash + totalCashFromSells;
            const cashShortfall = totalCashNeededForBuys - cashAfterSells;

            html += `
                <div style="background: #e7f3ff; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <h4>üí∞ Cash Flow Analysis</h4>
                    <table style="width: 100%; margin-top: 10px;">
                        <tr>
                            <td>Current Cash Balance:</td>
                            <td style="text-align: right;"><strong>${formatCAD(availableCash)}</strong></td>
                        </tr>
                        <tr>
                            <td>Cash from Sells:</td>
                            <td style="text-align: right; color: #28a745;"><strong>+ ${formatCAD(totalCashFromSells)}</strong></td>
                        </tr>
                        <tr style="border-top: 1px solid #ccc;">
                            <td>Available After Sells:</td>
                            <td style="text-align: right;"><strong>${formatCAD(cashAfterSells)}</strong></td>
                        </tr>
                        <tr>
                            <td>Cash Needed for Buys:</td>
                            <td style="text-align: right; color: #dc3545;"><strong>- ${formatCAD(totalCashNeededForBuys)}</strong></td>
                        </tr>
                        <tr style="border-top: 2px solid #333;">
                            <td><strong>Remaining Cash:</strong></td>
                            <td style="text-align: right; color: ${cashShortfall > 0 ? '#dc3545' : '#28a745'};"><strong>${formatCAD(cashAfterSells - totalCashNeededForBuys)}</strong></td>
                        </tr>
                    </table>
                    ${cashShortfall > 0 ? `
                        <div style="background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>‚ö†Ô∏è Insufficient Cash:</strong> You need an additional ${formatCAD(cashShortfall)} 
                            to complete all buy orders. Consider selling more, or depositing additional funds.
                        </div>
                    ` : `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <strong>‚úì Sufficient Cash:</strong> You have enough cash to complete all trades.
                        </div>
                    `}
                </div>
            `;

            // Display trades in proper sequence
            let tradeNumber = 1;
            const allTrades = [...sellTrades, ...buyTrades]; // Sells first, then buys

            if (allTrades.length === 0) {
                html += `
                    <div style="background: #d4edda; padding: 20px; border-radius: 6px; text-align: center; border-left: 4px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Portfolio is Well Balanced!</h3>
                        <p style="color: #155724;">Your current allocation is within acceptable range of your targets. No rebalancing needed at this time.</p>
                    </div>
                `;
            } else {
                // Add section headers
                if (sellTrades.length > 0) {
                    html += `<h4 style="margin-top: 20px; color: #dc3545;">Step 1: SELL Orders (Generate Cash) üí∏</h4>`;
                    
                    sellTrades.forEach(trade => {
                        html += renderTrade(trade, tradeNumber++, exchangeRate, formatCAD);
                    });
                }

                if (buyTrades.length > 0) {
                    html += `<h4 style="margin-top: 30px; color: #28a745;">Step 2: BUY Orders (Deploy Cash) üõí</h4>`;
                    
                    buyTrades.forEach(trade => {
                        html += renderTrade(trade, tradeNumber++, exchangeRate, formatCAD);
                    });
                }
            }

            html += '</div>';

            container.innerHTML = html;
            showAlert('Calculation complete', 'success');
            setTimeout(() => document.getElementById('alerts').innerHTML = '', 2000);
        }

        // Helper function to render individual trade
        function renderTrade(trade, tradeNumber, exchangeRate, formatCAD) {
            if (trade.error) {
                return `
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #dc3545;">
                        <strong>Trade #${tradeNumber}:</strong> ${trade.type} in <strong>${trade.assetClass}</strong>
                        <br><span style="color: #dc3545;">‚ö†Ô∏è ${trade.error}</span>
                    </div>
                `;
            }

            const security = trade.security;
            const actionColor = trade.type === 'BUY' ? '#28a745' : '#dc3545';
            const actionIcon = trade.type === 'BUY' ? 'üõí' : 'üí∏';
            const priceSymbol = security.price_currency === 'USD' ? '$' : 'C$';
            const priceDisplay = `${priceSymbol}${trade.price.toFixed(2)}`;

            // Build account recommendation
            let accountInfo = '';
            if (trade.recommendedAccounts.length === 1) {
                accountInfo = `in <strong>${trade.recommendedAccounts[0].name}</strong>`;
            } else if (trade.recommendedAccounts.length > 1) {
                const accountNames = trade.recommendedAccounts.slice(0, 3).map(a => a.name).join(', ');
                accountInfo = `in <strong>${accountNames}</strong>`;
                if (trade.recommendedAccounts.length > 3) {
                    accountInfo += ` or ${trade.recommendedAccounts.length - 3} other account(s)`;
                }
            }

            // Reason for account recommendation
            let accountReason = '';
            if (trade.accountReason === 'restricted') {
                accountReason = '<br><small style="color: #856404;">üîí Restricted to these accounts only</small>';
            } else if (trade.accountReason === 'preferred') {
                accountReason = '<br><small style="color: #0c5460;">‚≠ê Preferred accounts (can use others if needed)</small>';
            }

            return `
                <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid ${actionColor};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <strong>Trade #${tradeNumber}:</strong> 
                            <span style="color: ${actionColor}; font-weight: 600;">${actionIcon} ${trade.type}</span>
                        </div>
                        <div style="text-align: right;">
                            <strong style="color: ${actionColor}; font-size: 18px;">${formatCAD(trade.totalCostCAD)}</strong>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong style="font-size: 16px;">${security.symbol}</strong> - ${security.name || 'N/A'}
                        <br>
                        <strong>${trade.shares}</strong> shares @ ${priceDisplay} ${security.price_currency}
                        ${security.price_currency === 'USD' ? 
                            `<br><small>‚âà ${formatCAD(trade.totalCostCAD)} CAD (at ${exchangeRate.toFixed(4)} exchange rate)</small>` : 
                            ''}
                        <br>
                        Account: ${accountInfo}
                        ${accountReason}
                    </div>
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e0e0e0; color: #6c757d; font-size: 13px;">
                        üí° This will ${trade.type === 'BUY' ? 'increase' : 'decrease'} your <strong>${trade.assetClass}</strong> allocation
                        ${trade.selectionReason ? `<br>üìå Selected: ${trade.selectionReason}` : ''}
                        ${security.is_private ? '<br>üîí Private security (manual pricing)' : ''}
                    </div>
                </div>
            `;
        }

        async function refreshPricesForRebalance() {
            showAlert('This feature requires the price API to be working. Use Google Sheets import or manual prices instead.', 'info');
        }

    </script>
</body>
</html>

